generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum CaseStatus {
  OPEN
  REVIEWING
  NEEDS_USER_INPUT
  ESCALATE_TO_LAWYER
  CLOSED
}

enum AssetType {
  DOCUMENT_IMAGE
  DOCUMENT_PDF
  OTHER
}

enum ExtractionStatus {
  PENDING
  SUCCEEDED
  FAILED
}

enum VerdictStatus {
  PENDING
  READY
  FAILED
}

enum AuditEventType {
  OCR_RUN
  CLASSIFY_RUN
  TRUTH_LAYER_RUN
  LLM_FORMAT_RUN
  CASE_UPDATED
}

enum LawyerStatus {
  PENDING
  ACTIVE
  PAUSED
}

enum ChatSender {
  USER
  SYSTEM
  LAWYER
}

model User {
  id                 String        @id @default(cuid())
  authProviderUserId String        @unique
  email              String        @unique
  fullName           String?
  zipCode            String?
  jurisdictionState  String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  cases          Case[]
  uploadedAssets Asset[]       @relation("UploadedAssets")
  lawyerProfile  Lawyer?
  chatSessions   ChatSession[]
}

model Case {
  id                        String      @id @default(cuid())
  userId                    String
  title                     String?
  documentType              String?
  classificationConfidence  Float?
  status                    CaseStatus  @default(OPEN)
  timeSensitive             Boolean     @default(false)
  earliestDeadline          DateTime?
  jurisdictionZip           String?
  jurisdictionState         String?
  jurisdictionCounty        String?
  plainEnglishExplanation   String?     @db.Text
  nonLegalAdviceDisclaimer  String?     @db.Text
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime    @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assets       Asset[]
  extractions  Extraction[]
  verdicts     Verdict[]
  auditLogs    AuditLog[]
  chatSessions ChatSession[]

  @@index([userId])
  @@index([status])
  @@index([earliestDeadline])
}

model Asset {
  id             String    @id @default(cuid())
  caseId         String
  uploaderUserId String
  assetType      AssetType @default(DOCUMENT_IMAGE)
  s3Key          String    @unique
  fileName       String
  mimeType       String
  byteSize       Int
  sha256         String?
  createdAt      DateTime  @default(now())

  case        Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  uploader    User         @relation("UploadedAssets", fields: [uploaderUserId], references: [id])
  extractions Extraction[]
  auditLogs   AuditLog[]

  @@index([caseId])
  @@index([uploaderUserId])
}

model Extraction {
  id                String           @id @default(cuid())
  caseId            String
  assetId           String
  engine            String           @default("google-vision-ocr")
  engineVersion     String?
  rawText           String           @db.Text
  structuredFacts   Json
  status            ExtractionStatus @default(SUCCEEDED)
  createdAt         DateTime         @default(now())

  case      Case       @relation(fields: [caseId], references: [id], onDelete: Cascade)
  asset     Asset      @relation(fields: [assetId], references: [id], onDelete: Cascade)
  verdicts  Verdict[]
  auditLogs AuditLog[]

  @@index([caseId])
  @@index([assetId])
}

model Verdict {
  id             String       @id @default(cuid())
  caseId         String
  extractionId   String?
  llmModel       String
  inputHash      String
  outputJson     Json
  status         VerdictStatus @default(READY)
  createdAt      DateTime     @default(now())

  case       Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)
  extraction Extraction? @relation(fields: [extractionId], references: [id], onDelete: SetNull)
  auditLogs  AuditLog[]

  @@index([caseId])
  @@index([extractionId])
}

model AuditLog {
  id           String         @id @default(cuid())
  caseId       String?
  assetId      String?
  extractionId String?
  verdictId    String?
  eventType    AuditEventType
  actorType    String         @default("system")
  actorId      String?
  requestId    String?
  payload      Json
  createdAt    DateTime       @default(now())

  case       Case?       @relation(fields: [caseId], references: [id], onDelete: SetNull)
  asset      Asset?      @relation(fields: [assetId], references: [id], onDelete: SetNull)
  extraction Extraction? @relation(fields: [extractionId], references: [id], onDelete: SetNull)
  verdict    Verdict?    @relation(fields: [verdictId], references: [id], onDelete: SetNull)

  @@index([caseId])
  @@index([eventType])
  @@index([createdAt])
}

model Lawyer {
  id          String       @id @default(cuid())
  userId      String       @unique
  firmName    String?
  barState    String?
  status      LawyerStatus @default(PENDING)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChatSession {
  id        String       @id @default(cuid())
  caseId    String
  userId    String
  startedAt DateTime     @default(now())
  closedAt  DateTime?

  case     Case          @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([caseId])
  @@index([userId])
}

model ChatMessage {
  id         String      @id @default(cuid())
  sessionId  String
  sender     ChatSender
  body       String      @db.Text
  createdAt  DateTime    @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}
